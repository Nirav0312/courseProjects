import numpy as np
import pickle
import os


with open("data//Static_Analysis_RAWDATA//top_ngrams", 'rb') as file:
    features = pickle.load(file)


no_of_elements = len(features)
base_path="data//Static_Analysis_RAWDATA"
benign = "Benign"
opcode = "Opcodes.txt"
code_only = "code"

folders = os.listdir(base_path+"//"+benign)

folders = sorted(folders)

i = 0


current_set = set()

for folder in folders:

    print(i)
    i+=1

    opcode_file = base_path+"//"+benign+"//"+folder+"//"+code_only
    write_to = base_path + "//" + benign + "//" + folder + "//" + "feature_vector"

    # print(opcode_file)

    with open(opcode_file, 'rb') as pickle_file:
        list_opcode = pickle.load(pickle_file)

        current_set.update(''.join(list_opcode[i:i + 3]) for i in range(len(list_opcode) - 2))

        xy, f_ind, cs_ind = np.intersect1d(features, np.array(list(current_set)), return_indices=True)
        current_set.clear()

        feature_set = np.array([0] * no_of_elements).astype(np.uint8)
        feature_set[f_ind] = 1

        # print(feature_set)

        with open(write_to, 'wb') as file:
            pickle.dump(feature_set, file)
