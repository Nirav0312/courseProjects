import numpy as np
import pickle
import os


with open("data//Static_Analysis_RAWDATA//top_ngrams", 'rb') as file:
    features = pickle.load(file)


no_of_elements = len(features)

current_set = set()

base_path = "data//Static_Analysis_RAWDATA//Malware"
code_only = "code"

folders_category = os.listdir(base_path)
folders_category = sorted(folders_category)

feature_Set = set()

l=0
i=0
zero_len_files = list()

for category in folders_category:
    # print(category)
    folders = os.listdir(base_path + "//" + category)

    for folder in folders:

        opcode_file = base_path + "//" + category + "//" + folder + "//" + code_only
        write_to = base_path + "//" + category + "//" + folder + "//" + "feature_vector"

        i+=1
        print(i)

        with open(opcode_file, 'rb') as pickle_file:
            list_opcode = pickle.load(pickle_file)

            current_set.update(''.join(list_opcode[i:i + 3]) for i in range(len(list_opcode) - 2))

            xy, f_ind, cs_ind = np.intersect1d(features, np.array(list(current_set)), return_indices=True)
            current_set.clear()

            feature_set = np.array([0] * no_of_elements).astype(np.uint8)
            feature_set[f_ind] = 1

            # print(feature_set)

            with open(write_to, 'wb') as file:
                pickle.dump(feature_set, file)
