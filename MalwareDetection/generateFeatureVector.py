import pickle
import os
import numpy as np
import time

with open("data//Static_Analysis_RAWDATA//featureset_combined", 'rb') as file:
    ngram_set = pickle.load(file)


no_of_elements = len(ngram_set)
ngram_set = np.array(list(ngram_set))


base_path="data//Static_Analysis_RAWDATA"
benign = "Benign"
opcode = "Opcodes.txt"
code_only = "code"

folders = os.listdir(base_path+"//"+benign)

folders = sorted(folders)

i = 0


current_set = set()

for folder in folders[:100]:

    print(i)
    i+=1
    opcode_file = base_path+"//"+benign+"//"+folder+"//"+code_only
    write_to = base_path+"//"+benign+"//"+folder+"//"+"feature_vector"

    print(opcode_file)

    with open(opcode_file, 'rb') as pickle_file:

        list_opcode = pickle.load(pickle_file)

        current_set.update(''.join(list_opcode[i:i + 3]) for i in range(len(list_opcode) - 2))

        xy, x_ind, y_ind = np.intersect1d(ngram_set, np.array(list(current_set)), return_indices=True)
        current_set.clear()

        featureset = np.array([0]*no_of_elements).astype(np.bool)
        featureset[x_ind] = 1

        with open(write_to, 'wb') as file:
            pickle.dump(featureset, file)


